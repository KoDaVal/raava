<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" href="/static/raava_logo.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raava AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    /* Variables CSS para modo oscuro y claro */
    :root {
      --bg-color: #000;
      --sidebar-bg: #0a0a0a;
      --panel-bg: #0a0a0a;
      --chat-bg: #121212;
      --text-color: #e0e0e0;
      --link-color: #bbbbbb;
      --message-bg: #1e1e1e;
      --message-user-bg: #2d2d2d;
      --button-bg: #1e1e1e;
      --border-color: #1e1e1e;
      --hover-color: #292929;
      --button-text-color: #cccccc;
      --avatar-name-color: #f0f0f0;
      --quote-color: #aaaaaa;
    }

    body.light-mode {
      --bg-color: #f2f2f2;
      --sidebar-bg: #ffffff;
      --panel-bg: #ffffff;
      --chat-bg: #ffffff;
      --text-color: #111;
      --link-color: #333;
      --message-bg: #dddddd;
      --message-user-bg: #c1c1c1;
      --button-bg: #dddddd;
      --border-color: #d1d1d1;
      --hover-color: #c1c1c1;
      --button-text-color: #555;
      --avatar-name-color: #333;
      --quote-color: #555;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      transition: background 0.3s, color 0.3s;
    }

    .sidebar {
      background-color: var(--sidebar-bg);
      width: 220px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
    }

    .sidebar h2 {
      color: var(--text-color);
      margin-bottom: 30px;
      font-size: 18px;
      font-weight: 600;
    }

    .sidebar a {
      color: var(--link-color);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 18px;
      display: block;
      padding: 6px 0;
      border-radius: 4px;
      transition: all 0.25s ease-in-out;
    }

    .sidebar a:hover {
      background-color: var(--hover-color);
      color: var(--text-color);
      padding-left: 8px;
    }

    #toggle-theme {
      margin-top: auto; /* Empuja el botón al final de la barra lateral */
      font-size: 12px;
      cursor: pointer;
      color: var(--link-color);
      padding: 10px 0;
      text-align: center;
      border-top: 1px solid var(--border-color);
    }
    
    #toggle-theme:hover {
      color: var(--text-color);
    }

    .chat-area {
      flex: 1;
      background-color: var(--chat-bg);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
    }

    .messages {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .message {
      background-color: var(--message-bg);
      padding: 12px 16px;
      border-radius: 12px;
      width: fit-content;
      max-width: 70%;
      font-size: 14px;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      line-height: 1.6;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .message.appeared {
        opacity: 1;
        transform: translateY(0);
    }

    .message.user {
      align-self: flex-end;
      background-color: var(--message-user-bg);
      color: var(--text-color);
    }

    .message.bot {
      align-self: flex-start;
      color: var(--text-color);
    }

    .input-bar {
      display: flex;
      flex-wrap: wrap;
      margin-top: 20px;
      background-color: var(--button-bg);
      border-radius: 10px;
      padding: 4px 8px;
      align-items: flex-end;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .file-button {
      background: transparent;
      border: none;
      color: var(--button-text-color);
      padding: 8px;
      font-size: 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 6px;
    }

    .file-button:hover {
      background-color: var(--hover-color);
    }

    .input-bar textarea {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--text-color);
      outline: none;
      font-size: 14px;
      resize: none;
      overflow-y: hidden;
      min-height: 40px;
      line-height: 1.5;
      margin: 0 8px;
    }

    .send-button {
      background: transparent;
      border: none;
      color: var(--button-text-color);
      padding: 8px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .send-button:hover {
      background-color: var(--hover-color);
    }
    
    .send-button svg {
      fill: currentColor;
    }

    .file-info {
      display: flex;
      align-items: center;
      background-color: var(--hover-color);
      padding: 4px 8px;
      border-radius: 6px;
      margin-left: 8px;
      color: var(--text-color);
      font-size: 12px;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .clear-file {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 14px;
      margin-left: 6px;
      cursor: pointer;
    }

    .clear-file:hover {
      color: #fff;
    }

    .info-panel {
      background-color: var(--panel-bg);
      width: 260px;
      padding: 20px;
      border-left: 1px solid var(--border-color);
    }

    .info-panel h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-color);
    }

    .menu-option {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--button-text-color);
      margin-bottom: 12px;
      cursor: pointer;
      transition: color 0.2s ease-in-out;
    }

    .menu-option:hover {
      color: var(--text-color);
    }

    .menu-option i {
      width: 16px;
      height: 16px;
      background-color: #333333;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .avatar {
      width: 100%;
      border-radius: 8px;
      margin: 16px 0;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .name {
      font-size: 14px;
      font-weight: 600;
      color: var(--avatar-name-color);
    }

    .quote {
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
      color: var(--quote-color);
    }

    .start-button {
      margin-top: 20px;
      width: 100%;
      background-color: #333333;
      color: white;
      font-weight: 600;
      font-size: 13px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .start-button:hover {
      background-color: #444444;
    }

    .typing-indicator {
      display: flex;
      align-self: flex-start;
      background-color: var(--message-bg);
      padding: 10px 15px;
      border-radius: 10px;
      width: fit-content;
      max-width: 70%;
      margin-right: auto;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background-color: var(--text-color);
      border-radius: 50%;
      margin: 0 2px;
      animation: blink 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <h2>Hi, Paolo</h2>
    <a href="#">Inicio</a>
    <a href="#">Buscar chat</a>
    <a href="#">Nuevo chat</a>
    <a href="#">Comunidad</a>
    <a href="#">Premium</a>
    <div id="toggle-theme">Cambiar a Modo Claro</div>
  </div>

  <div class="chat-area">
    <div class="messages"></div>
    <div class="input-bar">
      <label for="file-upload" class="file-button" title="Adjuntar archivo">+</label>
      <input type="file" id="file-upload" hidden>
      <div id="file-display" style="display: none;" class="file-info">
        <span id="file-name"></span>
        <button id="clear-file" class="clear-file" title="Limpiar archivo adjunto">x</button>
      </div>
      <textarea id="user-input" placeholder="Enviar un mensaje..." rows="1"></textarea>
      <button id="send-button" class="send-button" title="Enviar mensaje">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <path d="M2 21l21-9L2 3v7l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="info-panel">
    <h4>Upload data</h4>
    <div class="menu-option">
      <i></i>
      <span>Archivo de voz</span>
    </div>
    <div class="menu-option">
      <i></i>
      <span>Imagen</span>
    </div>
    <div class="menu-option">
      <i></i>
      <span>Información</span>
    </div>
    <img src="/static/person.jpg" alt="Mi foto de perfil" class="avatar">
    <div class="name">Kobe Bryant</div>
    <div class="quote">
      The most important thing<br>
      is to try and inspire people<br>
      so that they can be great<br>
      in whatever they want to do.
    </div>
    <button class="start-button">Iniciar mente</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggleTheme = document.getElementById('toggle-theme');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const messagesContainer = document.querySelector('.messages');
        const fileInput = document.getElementById('file-upload');
        const fileDisplay = document.getElementById('file-display');
        const fileNameSpan = document.getElementById('file-name');
        const clearFileButton = document.getElementById('clear-file');
        let typingIndicatorElement = null;
        let selectedFile = null;
        let conversationHistory = [];

        // Función para ajustar la altura del textarea dinámicamente
        function adjustTextareaHeight() {
            userInput.style.height = 'auto'; // Reset height to recalculate
            userInput.style.height = userInput.scrollHeight + 'px'; // Set to scroll height
        }
        userInput.addEventListener('input', adjustTextareaHeight);
        userInput.addEventListener('focus', adjustTextareaHeight);
        userInput.addEventListener('blur', adjustTextareaHeight);

        // Lógica del modo oscuro y claro
        toggleTheme.addEventListener('click', () => {
          document.body.classList.toggle('light-mode');
          toggleTheme.textContent = document.body.classList.contains('light-mode')
            ? 'Cambiar a Modo Oscuro' : 'Cambiar a Modo Claro';
        });

        async function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender);
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            conversationHistory.push({
                role: sender === 'user' ? 'user' : 'model',
                parts: [{ text: text }]
            });

            setTimeout(() => {
                messageElement.classList.add('appeared');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
            return Promise.resolve();
        }

        function showTypingIndicator() {
            if (typingIndicatorElement) return;

            typingIndicatorElement = document.createElement('div');
            typingIndicatorElement.classList.add('message', 'bot', 'typing-indicator');
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                typingIndicatorElement.appendChild(dot);
            }
            messagesContainer.appendChild(typingIndicatorElement);
            void typingIndicatorElement.offsetWidth;
            typingIndicatorElement.style.opacity = '1';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            if (typingIndicatorElement && messagesContainer.contains(typingIndicatorElement)) {
                typingIndicatorElement.style.opacity = '0';
                setTimeout(() => {
                    if (typingIndicatorElement && messagesContainer.contains(typingIndicatorElement)) {
                        messagesContainer.removeChild(typingIndicatorElement);
                        typingIndicatorElement = null;
                    }
                }, 300);
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                fileNameSpan.textContent = selectedFile.name;
                fileDisplay.style.display = 'flex';
            } else {
                selectedFile = null;
                fileDisplay.style.display = 'none';
            }
        });

        clearFileButton.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileDisplay.style.display = 'none';
            adjustTextareaHeight();
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            const actualFile = fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (!message && !actualFile) {
                console.warn("Intento de envío vacío: no hay mensaje ni archivo adjunto.");
                return;
            }
            
            selectedFile = actualFile;

            let displayMessage = message;
            if (selectedFile) {
                displayMessage += (message ? ' ' : '') + `📎 Archivo adjunto: ${selectedFile.name}`;
            }
            await addMessage('user', displayMessage);
            
            userInput.value = '';
            adjustTextareaHeight();

            showTypingIndicator();

            try {
                const formData = new FormData();
                formData.append('message', message);
                formData.append('history', JSON.stringify(conversationHistory.slice(0, -1)));

                if (selectedFile) {
                    formData.append('file', selectedFile);
                }

                const response = await fetch('https://raava.onrender.com/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}. ${errorText}`);
                }
                const data = await response.json();
                hideTypingIndicator();
                await addMessage('bot', data.response);
                
                selectedFile = null;
                fileInput.value = '';
                fileDisplay.style.display = 'none';
                adjustTextareaHeight();

            } catch (error) {
                console.error('Error al comunicarse con el backend:', error);
                hideTypingIndicator();
                await addMessage('bot', 'Lo siento, hubo un error al conectar con el chatbot. Por favor, revisa la consola del navegador y asegúrate de que el backend esté corriendo.');
                
                conversationHistory.pop();
                selectedFile = null;
                fileInput.value = '';
                fileDisplay.style.display = 'none';
                adjustTextareaHeight();
            }
        }

        // Mensaje de bienvenida inicial
        (async () => {
             await addMessage('bot', '¡Hola! Soy Raava. ¿En qué puedo ayudarte hoy?');
        })();
    });
  </script>
</body>
</html>
